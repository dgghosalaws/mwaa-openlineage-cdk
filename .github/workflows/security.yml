name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety checkov

      # 1. Bandit - Python security scanner
      - name: Run Bandit (Python Security)
        run: |
          echo "Running Bandit security scanner..."
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt || true
        continue-on-error: true

      # 2. Safety - Dependency vulnerability scanner
      - name: Run Safety (Dependency Check)
        run: |
          echo "Checking for known security vulnerabilities in dependencies..."
          safety check --json --output safety-report.json || true
          safety check || true
        continue-on-error: true

      # 3. Checkov - Infrastructure as Code scanner
      - name: Run Checkov (IaC Security)
        run: |
          echo "Scanning CDK infrastructure code..."
          checkov -d . --framework cloudformation --output json --output-file checkov-report.json || true
          checkov -d . --framework cloudformation || true
        continue-on-error: true

      # 4. Secret scanning
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      # 5. CDK Security Check
      - name: CDK Security Check
        run: |
          echo "Synthesizing CDK and checking for security issues..."
          npm install -g aws-cdk
          cdk synth --quiet || echo "CDK synth failed, skipping security check"
        continue-on-error: true

      # 6. Upload security reports
      - name: Upload Bandit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json
          if-no-files-found: ignore

      - name: Upload Safety Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safety-report
          path: safety-report.json
          if-no-files-found: ignore

      - name: Upload Checkov Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: checkov-report.json
          if-no-files-found: ignore

      # 7. Security summary
      - name: Security Scan Summary
        if: always()
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Bandit (Python security)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Safety (Dependency vulnerabilities)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Checkov (Infrastructure as Code)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ TruffleHog (Secret scanning)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ CDK Security Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the detailed reports in the workflow artifacts." >> $GITHUB_STEP_SUMMARY

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
